<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Admin Kecemasan - Hanna</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .emergency-glow { box-shadow: 0 0 20px rgba(220, 38, 38, 0.3); }
        audio::-webkit-media-controls-panel { background-color: #1e293b; }
    </style>
</head>
<body class="bg-[#0f172a] text-white p-8 font-sans">
    
    <audio id="notifBiasa" src="https://actions.google.com/sounds/v1/alarms/alarm_clock_ringing_rising.ogg" preload="auto"></audio>
    <audio id="notifSOS" src="https://actions.google.com/sounds/v1/alarms/alarm_clock_ringing_rising.ogg" preload="auto"></audio>

    <div id="lock" class="fixed inset-0 bg-[#0f172a] z-50 flex flex-col items-center justify-center">
        <div class="bg-slate-800 p-10 rounded-[3rem] shadow-2xl text-center border-2 border-red-600/30 w-full max-w-sm">
            <h2 class="mb-8 font-black text-2xl uppercase italic">Hanna Access</h2>
            <p class="text-[10px] text-yellow-500 mb-4 uppercase font-black animate-pulse">‚ö†Ô∏è KLIK TOMBOL UNTUK AKTIFKAN ALARM</p>
            <input type="password" id="inputPin" class="bg-slate-900 text-white p-5 rounded-2xl mb-4 text-center text-2xl font-black w-full border-2 border-slate-700 focus:border-red-500" placeholder="****">
            <button onclick="cekLogin()" class="bg-red-600 w-full py-5 rounded-2xl font-black hover:bg-red-700 transition uppercase tracking-widest">Buka & Aktifkan Suara</button>
        </div>
    </div>

    <div id="dash" class="hidden max-w-4xl mx-auto">
        <div class="flex justify-between items-end mb-10 border-b-2 border-red-600/20 pb-6">
            <h1 class="text-4xl font-black text-red-600 italic uppercase">Admin Page</h1>
            <button onclick="location.reload()" class="bg-slate-800 px-6 py-2 rounded-full text-[10px] font-black uppercase border border-slate-700">Logout</button>
        </div>

        <div class="flex gap-4 mb-8">
            <button onclick="gantiTab('aktif')" id="tabAktif" class="flex-1 py-4 rounded-2xl font-black border-2 border-red-600 bg-red-600">üö® Aktif (<span id="countAktif">0</span>)</button>
            <button onclick="gantiTab('selesai')" id="tabSelesai" class="flex-1 py-4 rounded-2xl font-black border-2 border-slate-700 bg-slate-800 text-slate-400">‚úÖ Selesai (<span id="countSelesai">0</span>)</button>
        </div>
        <div id="konten" class="space-y-6"></div>
    </div>

    <script>
        let tabSekarang = 'aktif';
        let laporanLama = []; 
        const DB_URL = "https://projectkecemasan-default-rtdb.asia-southeast1.firebasedatabase.app/laporan.json";

        function pancingSuara() {
            const b = document.getElementById('notifBiasa');
            const s = document.getElementById('notifSOS');
            b.muted = false;
            s.muted = false;
            b.play().then(() => { b.pause(); b.currentTime = 0; });
            s.play().then(() => { s.pause(); s.currentTime = 0; });
        }

        function cekLogin() {
            if(document.getElementById('inputPin').value === "1234") {
                pancingSuara(); 
                document.getElementById('lock').classList.add('hidden');
                document.getElementById('dash').classList.remove('hidden');
                
                fetch(DB_URL).then(res => res.json()).then(data => {
                    if(data) laporanLama = Object.keys(data);
                    tampilData(data ? Object.keys(data).map(key => ({ ...data[key], idFirebase: key })) : []);
                });

                setInterval(ambilDataBaru, 3000);
            } else { alert("PIN Salah!"); }
        }

        function ambilDataBaru() {
            fetch(DB_URL).then(res => res.json()).then(data => {
                if (!data) return;
                const keys = Object.keys(data);
                
                keys.forEach(key => {
                    if (!laporanLama.includes(key)) {
                        const laporan = data[key];
                        
                        // SEKARANG SEMUA LAPORAN PAKAI SUARA DARURAT YANG SAMA
                        if (laporan.prioritas.includes("SOS")) {
                            const audSOS = document.getElementById('notifSOS');
                            audSOS.currentTime = 0;
                            audSOS.play();
                            alert("üö®üö®üö® LAPORAN DARURAT SOS: " + laporan.nama.toUpperCase());
                        } else {
                            const audBiasa = document.getElementById('notifBiasa');
                            audBiasa.currentTime = 0;
                            audBiasa.play();
                            // Untuk laporan biasa tidak pakai alert agar tidak terlalu mengganggu jika banyak
                        }
                        
                        laporanLama.push(key);
                    }
                });

                const list = keys.map(key => ({ ...data[key], idFirebase: key }));
                tampilData(list);
            });
        }

        function gantiTab(t) { tabSekarang = t; ambilDataBaru(); }

        function tampilData(list) {
            const dataAktif = list.filter(l => !l.sudahDitangani);
            const dataSelesai = list.filter(l => l.sudahDitangani);
            document.getElementById('countAktif').innerText = dataAktif.length;
            document.getElementById('countSelesai').innerText = dataSelesai.length;

            const dataTampil = tabSekarang === 'aktif' ? dataAktif : dataSelesai;
            document.getElementById('konten').innerHTML = dataTampil.reverse().map(l => {
                const waLink = l.whatsapp && l.whatsapp !== "-" ? `https://wa.me/${l.whatsapp.startsWith('0') ? '62'+l.whatsapp.slice(1) : l.whatsapp}` : null;
                const gps = l.lokasi ? l.lokasi : "0,0";
                return `
                <div class="p-6 rounded-[3rem] border-2 bg-slate-800 ${l.sudahDitangani ? 'border-slate-700' : 'border-red-600/40 emergency-glow'}">
                    <div class="flex justify-between mb-4">
                        <span class="text-[10px] text-slate-500 font-black">${l.waktu}</span>
                        <span class="text-[9px] px-3 py-1 rounded-full bg-red-600 font-black uppercase">${l.prioritas}</span>
                    </div>
                    <div class="mb-4">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-[10px] text-red-500 font-black italic">üë§ Pelapor: ${l.nama}</span>
                            ${waLink ? `<a href="${waLink}" target="_blank" class="bg-green-600 text-[8px] px-2 py-1 rounded-lg font-black">üí¨ CHAT WA</a>` : ''}
                        </div>
                        <h3 class="text-2xl font-bold">"${l.teks}"</h3>
                    </div>
                    ${l.suara ? `<div class="mb-4 p-3 bg-slate-900 rounded-2xl border border-slate-700"><p class="text-[8px] mb-2 font-black uppercase text-slate-500">üîä Rekaman Suara:</p><audio controls class="w-full h-8"><source src="${l.suara}" type="audio/mp3"></audio></div>` : ''}
                    <div class="flex justify-between items-center pt-4 border-t border-slate-700/50">
                        <a href="https://www.google.com/maps?q=${gps}" target="_blank" class="text-blue-400 text-[10px] font-black uppercase">üìç Lihat Lokasi</a>
                        ${!l.sudahDitangani ? `<button onclick="selesai('${l.idFirebase}')" class="bg-white text-black px-6 py-2 rounded-xl text-[10px] font-black">Selesai Ditangani</button>` : '<span class="text-green-500 text-[9px] font-black uppercase">‚úÖ Selesai</span>'}
                    </div>
                </div>`;
            }).join('');
        }

        function selesai(id) {
            fetch(`https://projectkecemasan-default-rtdb.asia-southeast1.firebasedatabase.app/laporan/${id}.json`, {
                method: 'PATCH', body: JSON.stringify({ sudahDitangani: true })
            }).then(() => ambilDataBaru());
        }
    </script>
</body>
</html>
